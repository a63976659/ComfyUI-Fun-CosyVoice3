插件还未测试成功，请勿使用
---

# ComfyUI-Fun-CosyVoice3

基于阿里通义百聆语音大模型 Fun-CosyVoice 3.0 模型，为您提供极速、低显存占用且支持零样本克隆与方言控制的高质量语音合成节点。

---

## ✨ 核心优势

1. **轻量极速**：使用 0.5B 版本模型，推理速度极快，对显存要求低（4G 显存即可流畅运行），非常适合消费级显卡。
2. **SOTA 级克隆**：在零样本（Zero-shot）模式下，仅需 3-10 秒参考音频即可实现极高相似度的声音复刻。
3. **语言覆盖范围**：9种常用语言（中文、英语、日语、韩语、德语、西班牙语、法语、意大利语、俄语）。
4. **方言支持**：18种以上的中文方言/口音（广东话、闽南话、四川话、东北话、陕西话、山西话、上海话、天津话、山东话、宁夏话、甘肃话等）可选择。
5. **智能防错**：内置防“提示词泄漏”逻辑，自动处理 System Prompt 边界，解决 CosyVoice 常见的“把指令读出来”的问题。
6. **独立纯净**：作为独立插件发布，依赖精简，避免与庞大的 Audio-LLM 类插件产生复杂的环境冲突。
7. **发音修复**：支持中文拼音和英文CMU音素的发音修复，提供更多可控性，因此适用于生产使用。
8. **指令控制**：多种指令，如语言、方言、情感、速度、音量等，通过滑块精准控制**语速**和**音量**。
9. **文本规范化**：支持读取数字、特殊符号和各种文本格式，无需传统的前端模块。

**📅 待支持功能**

* **双向流处理**: 支持文本输入流和音频输出流，并在保持高质量音频输出的同时实现低至 150 毫秒的延迟。

---

## 🛠️ 节点使用说明

### 核心节点：`🎤 CosyVoice 3.0 语音合成` (Fun CosyVoice3)

该节点整合了 CosyVoice 3.0 的核心能力，支持三种工作模式：

#### 1. 零样本复刻 (Zero-shot) —— 🌟 推荐

* **用途**：复刻参考音频的声音，说出新的内容。
* **必填项**：
* `参考音频`：连接 加载音频 节点。
* `参考音频文本`：**必须填写**参考音频中说的话（用于对齐音色特征）。


* **特点**：还原度最高。

#### 2. 指令控制 (Instruct)

* **用途**：使用预训练音色或参考音色，通过指令调整语气。
* **控制项**：
* `语言` / `方言`：选择中文、河南话、粤语等。
* `语速` / `音量`：通过滑块调整（范围 -30 到 +30）。
* `情感`：输入“悲伤”、“激动”等词汇。


* **特点**：可玩性高，适合调整口音和节奏。

#### 3. 跨语言/精细控制

* **用途**：主要用于跨语言合成或使用 `[breath]`、`[laugh]` 等标签控制呼吸感。

---

## 📦 安装方法

### 第一步：克隆插件

进入您的 ComfyUI 插件目录（`ComfyUI/custom_nodes/`），打开终端执行：

```bash
git clone https://github.com/a63976659/ComfyUI-Fun-CosyVoice3.git

```

### 第二步：安装依赖 (⚠️ 重要)

由于 CosyVoice 的官方依赖较为复杂，为了防止破坏您现有的 Python 环境（特别是 Qwen 或 PyTorch 版本），**请务必使用以下命令安装**：

在 **ComfyUI 根目录** 下打开终端：

```bash
# 1. 安装基础依赖
.\python\python.exe -m pip install hyperpyyaml onnxruntime modelscope

# 2. 安装 CosyVoice (关键：加上 --no-deps 防止破坏现有 torch 环境)
.\python\python.exe -m pip install git+https://github.com/FunAudioLLM/CosyVoice.git --no-deps

```

*(如果您使用的是系统 Python 而非整合包，请直接使用 `pip` 替换 `.\python\python.exe -m pip`)*

### 第三步：Linux 环境兼容性说明 (Sox) 🐧

如果您在 Linux 系统下运行遇到 `sox` 相关的兼容性报错，请根据您的系统版本安装系统级依赖：

**Ubuntu / Debian:**

```bash
sudo apt-get install sox libsox-dev

```

**CentOS / RHEL:**

```bash
sudo yum install sox sox-devel

```

---

## ❓ 常见问题与排查

### Q1: 生成时报错 `AttributeError: 'NoneType' object has no attribute ...` 或 `No module named 'cosyvoice'`

* **原因**：依赖未正确安装。
* **解决**：请重新执行“安装方法”中的第二步，确保 `git+...` 那条命令执行成功。如果您无法连接 GitHub，请尝试手动下载 CosyVoice 源码放入插件目录。

### Q2: 合成的声音里混入了“请使用该声音”、“Use this voice”等奇怪的话？

* **原因**：这是 CosyVoice 模型本身的特性，当 Prompt 构建不规范时，它会把指令读出来。
* **解决**：本插件已在代码层面做了强制修正。如果依然出现，请确保您的`参考音频文本`与实际音频内容一致，且不要在`系统提示词`中输入过长的无关内容。

### Q3: 合成的声音到了后半段开始复读、乱读？

* **原因**：CosyVoice 3.0 对长文本支持有限。
* **解决**：官方建议**单句文本不要超过 30 秒**。如果是长文章，建议先分割成短句，分批次生成。

### Q4: 总是自动下载模型，速度很慢？

* **解决**：
1. 确保节点上的 `下载源` 选择了 **ModelScope**（国内最快）。
2. 模型下载后会缓存在 `ComfyUI/models/TTS/Fun-CosyVoice3-0.5B-2512` 目录下，首次运行成功后，下次即可离线使用。



### Q5: 安装依赖时提示冲突 (Conflict)？

* **解决**：请务必加上 `--no-deps` 参数安装 CosyVoice。这会告诉 pip 只下载 CosyVoice 的代码，而不去强制升级/降级您现有的 PyTorch 或 Transformers 库。
